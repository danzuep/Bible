<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bible Chapters Index</title>
<style>
  body {
    font-family: Arial, sans-serif;
    padding: 1rem;
    max-width: 800px;
    margin: auto;
  }
  details {
    margin-bottom: 1rem;
  }
  .section-content > div {
    margin: 0.3rem 0;
  }
  #books-list a {
    display: inline-block;
    margin: 0.15rem 0.5rem 0.15rem 0;
    padding: 0.25rem 0.5rem;
    background: #f0f0f0;
    border-radius: 3px;
    text-decoration: none;
    color: #333;
  }
  #books-list a:hover {
    background: #ddd;
  }
  label {
    margin-left: 0.3rem;
    cursor: pointer;
  }
</style>
</head>
<body>

<h1>Bible Chapters Index</h1>

<!-- Languages Section -->
<details open>
  <summary>Languages</summary>
  <div class="section-content" id="languages-container">
    <!-- Radios inserted dynamically -->
  </div>
</details>

<!-- Translations Section -->
<details open>
  <summary>Translations</summary>
  <div class="section-content" id="translations-container">
    <!-- Radios inserted dynamically -->
  </div>
</details>

<!-- Books Section -->
<details open>
  <summary>Bible Books</summary>
  <div class="section-content">
    <div class="books-list" id="books-list">
      <!-- Book links inserted dynamically -->
    </div>
  </div>
</details>

<script>
  (async () => {
    try {
      const dataResponse = await fetch('data.json');
      if (!dataResponse.ok) throw new Error('Failed to load data.json');
      const data = await dataResponse.json();

      const booksResponse = await fetch('books.json');
      if (!booksResponse.ok) throw new Error('Failed to load books.json');
      const books = await booksResponse.json();

      const languagesContainer = document.getElementById('languages-container');
      const translationsContainer = document.getElementById('translations-container');
      const booksList = document.getElementById('books-list');

      // State
      let currentLanguage = data.languages[0]?.id ?? '';
      let currentVersionId = data.versions[currentLanguage]?.[0]?.id ?? '';

      // Utility: Create radio input with unique ID and label
      function createRadio(name, value, labelText, checked, index) {
        const id = `${name}-${value}`;

        const input = document.createElement('input');
        input.type = 'radio';
        input.name = name;
        input.value = value;
        input.id = id;
        if (checked) input.checked = true;

        const label = document.createElement('label');
        label.htmlFor = id;
        label.textContent = labelText;

        const wrapper = document.createElement('div');
        wrapper.appendChild(input);
        wrapper.appendChild(label);

        return wrapper;
      }

      // Render Languages radios
      data.languages.forEach((lang, i) => {
        const labelText = lang.nativeName ? `${lang.name} (${lang.nativeName})` : lang.name;
        const radioWrapper = createRadio('language', lang.id, labelText, i === 0, i);
        languagesContainer.appendChild(radioWrapper);
      });

      // Render Translations radios for the current language
      function renderTranslations(langId) {
        translationsContainer.innerHTML = '';
        const versions = data.versions[langId] || [];
        versions.forEach((version, i) => {
          const meta = data.metadata[version.id];
          const labelText = meta?.name ?? version.abbreviation ?? version.id;
          const radioWrapper = createRadio('translation', version.id, labelText, i === 0, i);
          translationsContainer.appendChild(radioWrapper);
        });
      }

      // Render book links function
      function renderBooks() {
        booksList.innerHTML = '';

        if (!currentVersionId) return;

        // Get metadata for current version
        const meta = data.metadata[currentVersionId];
        if (!meta || !meta.path) {
          booksList.textContent = 'No metadata path found for this translation.';
          return;
        }

        const path = meta.path;  // example: "eng-WEB" or "zho-Hans-OCCB"

        books.forEach(({ code, name }) => {
          const url = `texts/${path}/${code}.html`;
          const a = document.createElement('a');
          a.href = url;
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
          a.title = name;
          a.textContent = code;
          booksList.appendChild(a);
        });
      }

      // Event listeners for language radios
      languagesContainer.querySelectorAll('input[name="language"]').forEach(input => {
        input.addEventListener('change', e => {
          if (e.target.checked) {
            currentLanguage = e.target.value;
            // Re-render translations for new language
            renderTranslations(currentLanguage);

            // Set currentVersionId to first version id of new language or empty string
            const newVersions = data.versions[currentLanguage] || [];
            currentVersionId = newVersions[0]?.id ?? '';

            // Add event listeners for new translation radios
            translationsContainer.querySelectorAll('input[name="translation"]').forEach(input => {
              input.addEventListener('change', e => {
                if (e.target.checked) {
                  currentVersionId = e.target.value;
                  renderBooks();
                }
              });
            });

            renderBooks();
          }
        });
      });

      // Initial rendering of translations radios and event listeners
      renderTranslations(currentLanguage);
      translationsContainer.querySelectorAll('input[name="translation"]').forEach(input => {
        input.addEventListener('change', e => {
          if (e.target.checked) {
            currentVersionId = e.target.value;
            renderBooks();
          }
        });
      });

      // Initial render of books
      renderBooks();

    } catch (error) {
      document.body.innerHTML = `<p style="color:red;">${error.message}</p>`;
      console.error(error);
    }
  })();
</script>

</body>
</html>